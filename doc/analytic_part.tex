\chapter{Аналитическая часть}
\section{Оптические эффекты, учитываемые при построении реалистичного изображения}
При построении реалистичных изображений необходимо учитывать такие эффекты оптики, как:
\begin{itemize}
	\item отражающие свойства поверхностей: диффузное и зеркальное отражения;
	\item преломление части света при взаимодействии луча с прозрачной поверхностью;
	\item рассеяние света.
\end{itemize}

Поскольку в данной работе не используются прозрачные объекты, будем рассматривать только отражение и рассеяние света.

Диффузная составляющая явления отражения света от поверхностей описывается следующим уравнением:
\begin{equation}
	I_\text{д} = I_\text{и} cos\theta \cdot k_\text{д}, 
\end{equation}
где $I_\text{и}$ -- интенсивность источника освещения, $\theta$ – угол между нормалью к поверхности в точке отражения и вектором, направленным из точки отражения к источнику света, $k_\text{д}$ -– коэффициент диффузного отражения.

Зеркальная составляющая явления отражения света описывается уравнением:
\begin{equation}
	I_\text{з} = I_\text{и} cos^n\alpha \cdot k_\text{з}, 
\end{equation}
где $I_\text{и}$ -- интенсивность источника освещения, $\alpha$ -- угол падения луча, $k_\text{з}$ -- коэффициент зеркального отражения, степень $n$ косинуса характеризует концентрированность света в направлении отражения.

Рассеяние света в компьютерной графике обычно описывают следующей формулой:
\begin{equation}
	I' = I_\text{р}k_\text{р}, 
\end{equation}
где $I_\text{р}$ -- интенсивность рассеянного света, $k_\text{р}$ -- коэффициент диффузного отражения рассеянного света.

Также необходимо учесть затухание света с расстоянием. Интенсивность света падает обратно пропорционально квадрату расстояния до источника, однако, как показывает практика, большей реалистичности можно добиться при линейном затухании \cite{lit1}. В этом случае получаем следующий результат:
\begin{equation}
	I = I_\text{р}k_\text{р} + \frac{I_\text{и} cos\theta \cdot k_\text{д} + I_\text{и} cos^n\alpha \cdot k_\text{з}}{d + K}, 
\end{equation}
где $d$ -- расстояние до источника освещения, $K$ -- произвольная константа.

\section{Модели представления объектов}
Существует пять основных методов представления объектов: аналитический, полигональный, воксельный, с помощью равномерной сетки и с помощью неравномерной сетки.

В рамках аналитически заданной модели объект описывается с помощью математических формул. В силу этого метод не подходит для описания произвольного объекта, однако для таких гладких поверхностей, как сфера, тор, цилиндры позволяет их точно, без погрешностей, представить. При этом поиск пересечения с другими простейшими объектами, например, лучом, выполняется за $O(1)$.

Полигональная сетка представляет собой совокупность связанных между собой многоугольников (чаще всего, треугольников), аппроксимирующих заданную поверхность. Так, любой объект можно представить с необходимой степенью детализации. Однако для данного способа задания объектов поиск пересечения с другими объектами выполняется за $O(n)$ операций, где $n$ -- число полигонов, из которых состоит объект.

Воксельная модель описывается как трехмерный массив вокселей, малых кубических элементов, для которых фиксируются параметры объекта в соответствующих ячейках объема (например, цвет). Метод подходит для описания произвольных объектов, однако пространственная сложность метода -- $O(n^3)$, где $n$ -- число ячеек в каждом измерении кубической сетки.

Эта модель описывает координаты отдельных точек поверхности следующим образом: к каждому узлу сетки с индексами $i, j$ приписывается значение высоты $z_\text{ij}$, при этом расстояние между узлами является равным по осям $Ox$ и $Oy$. Не каждая поверхность может быть представлена этой моделью. Если в каж­дом узле записывается только одно значение высоты, то это означает, что поверхность описывается однозначной функцией $z=f(x,y)$. Иначе говоря, это такая поверхность, которую любая вертикаль пересекает только один раз. Не могут моделироваться также вертикальные грани.

Неравномерная сетка представляет собой модель описания поверхности в виде множества отдельных точек, логически не связанных друг с другом. Такие точки могут быть получены, например, при измерении реальной поверхности, а их неравномерное расположение требует применения методов интерполяции для восстановления информации о других точках~\cite{lit9}.

Для поставленной задачи были выбраны аналитический и полигональный методы, поскольку полигональный метод позволяет задавать произвольные объекты, при этом имея меньшую сложность по памяти. С помощью аналитической модели можно без погрешности задать сферу, используемую в курсовой работе.


\section{Алгоритмы удаления невидимых линий и поверхностей}
Все алгоритмы удаления невидимых линий работают либо в пространстве объектов, либо в пространстве изображений. Рассмотрим наиболее известные из них.
\subsection{Алгоритм Робертса}
Этот алгоритм работает в объектном пространстве и использует проекции объектов на картинную плоскость для анализа видимости. Алгоритм прежде всего удаляет из каждого тела те ребра или грани, которые экранируются самим телом. Затем каждое из видимых ребер каждого тела сравнивается с каждым из оставшихся тел для определения того, какая его часть или части, если таковые есть, экранируются этими телами. Поэтому вычислительная трудоемкость алгоритма Робертса растет теоретически как квадрат числа объектов~\cite{lit1,lit2}.

\subsection{Алгоритм Варнака}
Алгоритм Варнака, работающий в пространстве изображений, реализует рекурсивное разбиение исходного окна на подокна для определения видимых объектов сцены. Если текущее окно содержит более одного объекта или пересекается с объектом, оно делится на четыре равные части. Процесс повторяется до тех пор, пока размер подокна не станет равен одному пикселю или оно не окажется полностью пустым. По завершении разбиения цвет пикселя определяется ближайшим видимым объектом. Основной недостаток алгоритма — высокая вычислительная сложность из-за рекурсивного характера, особенно при работе с деталями в высоком разрешении~\cite{lit3}.

\subsection{Алгоритм, использующий z-буфер}

Алгоритм основывается на хранении глубины (z-значения) каждого пикселя экрана и определении ближайшей к экрану точки при разложении многоугольников в растр.
Главное преимущество алгоритма -- его простота. Кроме того, этот алгоритм решает задачу об удалении невидимых поверхностей и делает тривиальной визуализацию пересечений сложных поверхностей -- сцены могут быть любой сложности.
Основной недостаток алгоритма -- большой объем требуемой памяти~\cite{lit1}. Также алгоритм требует модификаций и доработок для задач с отражениями, потому что он работает только с глубиной объектов для каждого пикселя экрана без учета траектории распространения отраженного света.


\subsection{Алгоритм обратной трассировки лучей}
Алгоритм трассировки лучей моделирует процесс формирования изображения путём симуляции распространения световых лучей в сцене. При прямой трассировке отслеживаются лучи, исходящие от источника света, что неэффективно, поскольку далеко не все лучи попадут в камеру, а значит, повлияют на изображение. По этой причине используется алгоритм обратной трассировки лучей. При обратной трассировке выполняется построение изображения, следя за траекторией лучей, исходящих из камеры. Лучи проверяют пересечения с объектами сцены, и, если такое пересечение обнаружено, рассчитывается цветовая характеристика точки с учётом материалов объекта, освещения, отражений и преломлений. Для моделирования этих эффектов алгоритм порождает вторичные лучи, что позволяет создавать реалистичные изображения. Основным недостатком метода является его высокая вычислительная сложность~\cite{lit2, lit3}.

\section{Методы закраски}
\subsection{Простая закраска}
Если предположить, что источник света находится на бесконечности, то лучи света, падающие на поверхность, параллельны между собой. Если к этому добавить условие, что наблюдатель находится в бесконечно удаленной точке, то эффектом ослабления света с увеличением расстояния от источника также можно пренебречь. При таких вводных плоская грань во всех ее точках имеет одинаковую интенсивность освещения, поэтому она закрашивается одним цветом.

При закрашивании этим методом на стыке соседних граней неизбежно будут проявляться ребра, поскольку соседние грани с различными направлениями нормалей имеют разный цвет~\cite{lit5}.

\subsection{Закраска методом Гуро}
Один из способов устранения дискретности интенсивностей закрашивания был предложен Гуро. Его метод заключается в том, что используются не нормали к плоским граням, а нормали к аппроксимируемой поверхности, построенные в вершинах многогранника. После этого вычисляются интенсивности в вершинах, а затем во всех внутренних точках многоугольника выполняется билинейная интерполяция интенсивности.
К недостаткам метода Гуро следует отнести то, что он хорошо работает только с диффузной моделью отражения. Форма бликов на поверхности и их расположение не могут быть адекватно воспроизведены при интерполяции на многоугольниках. Кроме того, есть проблема построения нормалей к поверхности. В алгоритме Гуро нормаль в вершине многогранника вычисляется путем усреднения нормалей к граням, примыкающим к этой вершине. Такое построение сильно зависит от характера разбиения. 

Еще один недостаток закраски изображен на рисунке \ref{fig:Guro_book}. Если нормали к вершинам B, C, D вычислить усреднением нормалей к многоугольникам, то они будут одинаково ориентированы, то есть интенсивность в этих точках будет равной. При линейной интерполяции от B до D значение интенсивности получится постоянным, и поверхность на данном участке будет выглядеть плоской~\cite{lit5}.

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\textwidth]{Knizhka.pdf}
	\caption{Пример некорректной работы закраски Гуро}
	\label{fig:Guro_book}
\end{figure}

\subsection{Закраска методом Фонга}
Фонг предложил вместо интерполяции интенсивностей произвести интерполяцию вектора нормали к поверхности на сканирующей строке. Этот метод требует больших вычислительных затрат, поскольку формулы интерполяции применяются уже к трем компонентам вектора нормали, но зато дает лучшую аппроксимацию кривизны поверхности. Поэтому зеркальные свойства поверхности воспроизводятся гораздо лучше.

Нормали к поверхности в вершинах многогранника вычисляются так же, как и в методе Гуро, после чего выполняется билинейная интерполяция в сочетании с построчным сканированием. После построения вектора нормали в очередной точке вычисляется интенсивность~\cite{lit5}.

\section{Построение теней}
Тени делятся на два вида: собственные и проекционные. Определение собственных теней не представляет сложностей: точка наблюдателя совмещается с положением источника света и решается задача определения видимых граней. Видимые грани окажутся освещенными, невидимые -- в тени.

Если источник света находится на бесконечном расстоянии, то при падении света на объект сцены будет образовываться полоса тени, которую можно задать уравнением. Если же источник света находится не на бесконечном расстоянии, возникает потребность нахождения проекции грани в тени на поверхность другого тела~\cite{lit6}.

Стоит отметить, что в случае алгоритма обратной трассировки лучей задача построения теней сводится к тому, чтобы при нахождении точки пересечения луча с объектом сцены провести еще один луч от этой точки к источнику света. Если на пути луча встречается преграда в виде поверхности какого-либо объекта сцены, точка находится в тени.

\section{Алгоритм симуляции эффекта глубины поля}
Алгоритм симуляции эффекта глубины поля, то есть алгоритм, позволяющий изображать объекты, расположенные ближе к фокальной плоскости более четкими, чем те, что расположены дальше от нее, является модификацией алгоритма трассировки лучей. Работа алгоритма заключается в том, чтобы применять случайное отклонение начала луча трассировки от положения камеры в пространстве в рамках круга заданного радиуса, называемого апертурой. Круг при этом лежит в плоскости, параллельной картинной плоскости.

В рамках данного алгоритма также вводится понятие фокальной точки, задающейся фиксированным расстоянием от камеры по вектору направления взгляда для каждого пикселя кадра. Таким образом, модифицированный трассируемый луч, начало которого задается с помощью случайной точки круга заданного радиуса, направляется к фокальной точке~\cite{DOF}.


\section*{Вывод}

В данном разделе были рассмотрены основные методы построения реалистичных изображений, а также модели представления объектов. Для удаления невидимых ребер, учета отражения света и теней, а также симуляции эффекта глубины поля в данной работе был выбран алгоритм обратной трассировки лучей в силу своей универсальности и реалистичности результата. В качестве реализуемых способов представления поверхностных моделей были выбраны аналитический способ и полигональная сетка. В качестве метода закраски был выбран метод Фонга, дающий лучшую аппроксимацию кривизны поверхности, чем метод Гуро.

\clearpage
